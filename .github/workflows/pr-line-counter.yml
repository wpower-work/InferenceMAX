name: PR Line Counter

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'utils/matrix-logic/**'

jobs:
  count-lines:
    if: github.event.pull_request.draft != true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      TARGET_FILE: utils/matrix-logic/generate_sweep_configs.py

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Count lines in generate_sweep_configs.py
        id: line-count
        run: |
          # Count lines in PR version
          if [ -f "$TARGET_FILE" ]; then
            LINE_COUNT=$(wc -l < "$TARGET_FILE")
            # If the last character is not a newline, increment the count
            if [ -n "$(tail -c 1 "$TARGET_FILE" | tr -d '\n')" ]; then
              LINE_COUNT=$((LINE_COUNT + 1))
            fi
            echo "line_count=$LINE_COUNT" >> $GITHUB_OUTPUT
            echo "file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "line_count=0" >> $GITHUB_OUTPUT
            LINE_COUNT=0
          fi

          # Count lines in base branch version
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          # Fetch the base branch to ensure we have it
          if ! git fetch origin "$BASE_REF" 2>/dev/null; then
            echo "ERROR: Failed to fetch base branch '$BASE_REF' from origin." >&2
            exit 1
          fi
          BASE_FILE_TMP=$(mktemp)
          # Ensure cleanup on exit
          trap "rm -f '$BASE_FILE_TMP'" EXIT
          if git show "origin/$BASE_REF:$TARGET_FILE" > "$BASE_FILE_TMP" 2>/dev/null; then
            BASE_LINE_COUNT=$(wc -l < "$BASE_FILE_TMP")
            # If the last character is not a newline, increment the count
            if [ -n "$(tail -c 1 "$BASE_FILE_TMP" | tr -d '\n')" ]; then
              BASE_LINE_COUNT=$((BASE_LINE_COUNT + 1))
            fi
            echo "base_line_count=$BASE_LINE_COUNT" >> $GITHUB_OUTPUT
            echo "base_file_exists=true" >> $GITHUB_OUTPUT

            # Calculate line difference
            LINE_DIFF=$((LINE_COUNT - BASE_LINE_COUNT))
            echo "line_diff=$LINE_DIFF" >> $GITHUB_OUTPUT
          else
            echo "base_file_exists=false" >> $GITHUB_OUTPUT
            echo "base_line_count=0" >> $GITHUB_OUTPUT
            # If base file doesn't exist, the diff is the full line count (new file)
            echo "line_diff=$LINE_COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Generate summary
        run: |
          echo "## ðŸ“Š Line Count Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FILE_EXISTS="${{ steps.line-count.outputs.file_exists }}"
          BASE_FILE_EXISTS="${{ steps.line-count.outputs.base_file_exists }}"

          if [ "$FILE_EXISTS" == "true" ]; then
            LINE_COUNT="${{ steps.line-count.outputs.line_count }}"
            BASE_LINE_COUNT="${{ steps.line-count.outputs.base_line_count }}"
            LINE_DIFF="${{ steps.line-count.outputs.line_diff }}"

            echo "**File:** \`$TARGET_FILE\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total Lines:** $LINE_COUNT" >> $GITHUB_STEP_SUMMARY

            if [ "$BASE_FILE_EXISTS" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Base Lines:** $BASE_LINE_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              if [ "$LINE_DIFF" -gt 0 ]; then
                echo "**Change:** +$LINE_DIFF lines ðŸ“ˆ" >> $GITHUB_STEP_SUMMARY
              elif [ "$LINE_DIFF" -lt 0 ]; then
                echo "**Change:** $LINE_DIFF lines ðŸ“‰" >> $GITHUB_STEP_SUMMARY
              else
                echo "**Change:** No change âž¡ï¸" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Base Lines:** 0 (new file)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Change:** +$LINE_DIFF lines ðŸ“ˆ" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ **File not found:** \`$TARGET_FILE\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const fileExists = '${{ steps.line-count.outputs.file_exists }}';
            const baseFileExists = '${{ steps.line-count.outputs.base_file_exists }}';
            const lineCount = '${{ steps.line-count.outputs.line_count }}';
            const baseLineCount = '${{ steps.line-count.outputs.base_line_count }}';
            const lineDiff = '${{ steps.line-count.outputs.line_diff }}';
            const targetFile = process.env.TARGET_FILE;

            let commentBody;
            if (fileExists === 'true') {
              commentBody = `## ðŸ“Š Line Count Report\n\n**File:** \`${targetFile}\`\n\n**Total Lines:** ${lineCount}`;

              if (baseFileExists === 'true') {
                commentBody += `\n\n**Base Lines:** ${baseLineCount}`;

                const diff = parseInt(lineDiff);
                if (diff > 0) {
                  commentBody += `\n\n**Change:** +${diff} lines ðŸ“ˆ`;
                } else if (diff < 0) {
                  commentBody += `\n\n**Change:** ${diff} lines ðŸ“‰`;
                } else {
                  commentBody += `\n\n**Change:** No change âž¡ï¸`;
                }
              } else {
                commentBody += `\n\n**Base Lines:** 0 (new file)`;
                commentBody += `\n\n**Change:** +${lineDiff} lines ðŸ“ˆ`;
              }
            } else {
              commentBody = `## ðŸ“Š Line Count Report\n\nâš ï¸ **File not found:** \`${targetFile}\``;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
